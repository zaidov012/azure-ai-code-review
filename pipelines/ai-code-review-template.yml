# Azure Pipelines template for AI Code Review
# 
# Usage in azure-pipelines.yml:
#   trigger: none  # Only run on PR
#   pr:
#     branches:
#       include:
#         - main
#         - develop
#   
#   extends:
#     template: pipelines/ai-code-review-template.yml
#     parameters:
#       llmProvider: 'openai'
#       llmModel: 'gpt-5'  # Options: gpt-5, gpt-4-turbo, o1-preview, o1-mini

parameters:
  # LLM Configuration
  - name: llmProvider
    type: string
    default: 'openai'
    values:
      - openai
      - azure_openai
      - anthropic
      - ollama

  - name: llmModel
    type: string
    default: 'gpt-4'
    # Options: gpt-5, gpt-4, gpt-4-turbo, o1-preview, o1-mini, claude-3-opus, etc.
    # Note: GPT-5 and o1 models automatically use extended timeout (10 min)

  - name: llmApiKey
    type: string
    default: ''

  - name: llmApiBase
    type: string
    default: ''

  - name: llmApiVersion
    type: string
    default: ''

  - name: llmTimeout
    type: number
    default: 60
    # Note: Reasoning models (GPT-5, o1) automatically use minimum 600s (10 min)

  # Review Configuration
  - name: reviewScope
    type: string
    default: |
      security
      performance
      code_quality
      best_practices
      bugs

  - name: fileExtensions
    type: string
    default: |
      .py
      .ts
      .js
      .tsx
      .jsx
      .java
      .cs
      .go
      .rb

  - name: excludePatterns
    type: string
    default: |
      **/test_*.py
      **/*.test.ts
      **/*.spec.js
      **/node_modules/**
      **/dist/**
      **/build/**

  - name: quickMode
    type: boolean
    default: false

  - name: postComments
    type: boolean
    default: true

  - name: postSummary
    type: boolean
    default: true

  - name: commentStyle
    type: string
    default: 'constructive'
    values:
      - constructive
      - direct
      - detailed

  - name: maxIssuesPerFile
    type: number
    default: 10

  # Runtime Configuration
  - name: pythonVersion
    type: string
    default: '3.10'

  - name: logLevel
    type: string
    default: 'INFO'
    values:
      - DEBUG
      - INFO
      - WARNING
      - ERROR

  # Advanced
  - name: configPath
    type: string
    default: ''

  - name: failOnCriticalIssues
    type: boolean
    default: false

  - name: vmImage
    type: string
    default: 'ubuntu-latest'

stages:
  - stage: AICodeReview
    displayName: 'AI Code Review'
    jobs:
      - job: ReviewPR
        displayName: 'Review Pull Request'
        pool:
          vmImage: ${{ parameters.vmImage }}
        
        steps:
          - checkout: self
            fetchDepth: 0
            persistCredentials: true
          
          - task: UsePythonVersion@0
            displayName: 'Use Python ${{ parameters.pythonVersion }}'
            inputs:
              versionSpec: ${{ parameters.pythonVersion }}
              addToPath: true
          
          - task: AICodeReview@1
            displayName: 'AI Code Review'
            inputs:
              configPath: ${{ parameters.configPath }}
              llmProvider: ${{ parameters.llmProvider }}
              llmModel: ${{ parameters.llmModel }}
              llmApiKey: ${{ parameters.llmApiKey }}
              llmApiBase: ${{ parameters.llmApiBase }}
              llmApiVersion: ${{ parameters.llmApiVersion }}
              llmTimeout: ${{ parameters.llmTimeout }}
              reviewScope: ${{ parameters.reviewScope }}
              fileExtensions: ${{ parameters.fileExtensions }}
              excludePatterns: ${{ parameters.excludePatterns }}
              quickMode: ${{ parameters.quickMode }}
              postComments: ${{ parameters.postComments }}
              postSummary: ${{ parameters.postSummary }}
              commentStyle: ${{ parameters.commentStyle }}
              maxIssuesPerFile: ${{ parameters.maxIssuesPerFile }}
              pythonVersion: ${{ parameters.pythonVersion }}
              logLevel: ${{ parameters.logLevel }}
            env:
              # Option 1: Use Build Service (default)
              # Requires PullRequestContribute permission - see PERMISSION_SETUP.md
              SYSTEM_ACCESSTOKEN: $(System.AccessToken)
              
              # Option 2: Use Personal Access Token
              # If you prefer to use a PAT token, comment out SYSTEM_ACCESSTOKEN above
              # and uncomment the line below, then set AZDO_PAT_TOKEN as a secret variable
              # AZDO_PERSONAL_ACCESS_TOKEN: $(AZDO_PAT_TOKEN)
              
              FAIL_ON_CRITICAL_ISSUES: ${{ parameters.failOnCriticalIssues }}
          
          - task: PublishBuildArtifacts@1
            displayName: 'Publish Review Results'
            condition: always()
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)/review-results.json'
              ArtifactName: 'ai-review-results'
            continueOnError: true
